name: Auto-Merge Low-Risk PRs

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  pull_request:
    types: [labeled]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      (
        github.event.review.state == 'approved' ||
        github.event.check_suite.conclusion == 'success' ||
        contains(github.event.pull_request.labels.*.name, 'artifacts-validated')
      )
    
    steps:
      - name: Check PR Eligibility
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            const prNumber = pr.number;
            
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const hasBlockingLabel = labels.some(l => 
              ['missing-artifacts', 'needs-manual-review', 'high-risk', 'breaking-change'].includes(l)
            );
            
            const hasApproval = reviews.some(r => r.state === 'APPROVED');
            const hasValidation = labels.includes('artifacts-validated');
            const allChecksPass = checks.check_runs.every(c => c.conclusion === 'success');
            const hasConflicts = prData.mergeable_state === 'dirty';
            
            const eligible = 
              !hasBlockingLabel &&
              hasValidation &&
              hasApproval &&
              allChecksPass &&
              !hasConflicts;
            
            console.log('Auto-merge eligibility:', {
              hasBlockingLabel,
              hasValidation,
              hasApproval,
              allChecksPass,
              hasConflicts,
              eligible
            });
            
            core.setOutput('eligible', eligible);
            core.setOutput('reason', 
              !hasValidation ? 'Missing artifact validation' :
              !hasApproval ? 'No approval' :
              !allChecksPass ? 'Checks failing' :
              hasConflicts ? 'Merge conflicts' :
              hasBlockingLabel ? 'Has blocking label' :
              'Unknown'
            );
            
            return eligible;
      
      - name: Merge PR
        if: steps.check.outputs.eligible == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '✅ **Auto-merge triggered**\n\nAll validation checks passed. Merging to main...'
            });
            
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash',
              commit_title: `${context.payload.pull_request.title} (#${prNumber})`,
              commit_message: 'Auto-merged by governance automation'
            });
            
            console.log(`✓ PR #${prNumber} auto-merged successfully`);
      
      - name: Comment If Ineligible
        if: steps.check.outputs.eligible == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `⏸️  **Auto-merge not triggered**\n\nReason: ${{ steps.check.outputs.reason }}\n\nThis PR requires manual approval from Deacon.`
            });

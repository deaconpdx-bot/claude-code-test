name: Daily Recap Email

on:
  schedule:
    - cron: '0 16 * * *'  # 8 AM PST = 4 PM UTC
  workflow_dispatch:  # Allows manual testing

jobs:
  send-recap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Get yesterday's PRs
        id: get_prs
        uses: actions/github-script@v7
        with:
          script: |
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const { data: merged } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 50
            });
            
            const mergedYesterday = merged.filter(pr => 
              pr.merged_at && pr.merged_at.startsWith(yesterdayStr)
            );
            
            const { data: open } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            core.setOutput('merged_count', mergedYesterday.length);
            core.setOutput('open_count', open.length);
            core.setOutput('merged_prs', JSON.stringify(mergedYesterday));
            core.setOutput('open_prs', JSON.stringify(open));
            
      - name: Generate recap with Claude
        id: generate
        run: |
          RECAP=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 2000,
              "messages": [{
                "role": "user",
                "content": "Generate a brief daily recap email for Deacon. Keep it under 200 words, scannable format.\n\nMerged PRs yesterday: ${{ steps.get_prs.outputs.merged_count }}\nOpen PRs: ${{ steps.get_prs.outputs.open_count }}\n\nMerged: ${{ steps.get_prs.outputs.merged_prs }}\nOpen: ${{ steps.get_prs.outputs.open_prs }}\n\nFormat:\n- Executive summary (2 sentences)\n- Key metrics\n- Notable PRs (title + link)\n- Action items"
              }]
            }' | jq -r '.content[0].text')
          
          echo "RECAP<<EOF" >> $GITHUB_OUTPUT
          echo "$RECAP" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Send email via SendGrid
        run: |
          TODAY=$(date +%Y-%m-%d)
          RECAP_ESCAPED=$(echo '${{ steps.generate.outputs.RECAP }}' | jq -Rs .)
          curl -s -X POST https://api.sendgrid.com/v3/mail/send \
            -H "Authorization: Bearer ${{ secrets.SENDGRID_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "personalizations": [{
                "to": [{"email": "Deacon@stoneforestproducts.com"}]
              }],
              "from": {"email": "recap@stoneforestproducts.com", "name": "Stone Forest Bot"},
              "subject": "Daily Recap: '"$TODAY"'",
              "content": [{
                "type": "text/plain",
                "value": '"$RECAP_ESCAPED"'
              }]
            }'
